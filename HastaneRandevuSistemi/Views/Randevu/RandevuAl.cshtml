@{
    ViewData["Title"] = "Randevu Al";
}

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow mt-4">
            <div class="card-header bg-primary text-white">
                <h4><i class="fas fa-calendar-plus"></i> Yeni Randevu Oluştur</h4>
            </div>
            <div class="card-body">

                @if (TempData["Hata"] != null)
                {
                    <div class="alert alert-danger">@TempData["Hata"]</div>
                }

                <form asp-action="RandevuOlustur" method="post">

                    <div class="mb-3">
                        <label class="form-label fw-bold">Poliklinik / Departman</label>
                        <select id="DepartmanListesi" class="form-select" asp-items="ViewBag.Departmanlar">
                            <option value="">-- Lütfen Önce Poliklinik Seçin --</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Doktor</label>
                        <select id="DoktorListesi" name="DoktorID" class="form-select" disabled required>
                            <option value="">-- Önce Poliklinik Seçiniz --</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Randevu Tarihi</label>
                        <input type="date" name="RandevuTarihi" class="form-control" required
                               min="@DateTime.Now.ToString("yyyy-MM-dd")" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Randevu Saati</label>
                        <select name="RandevuSaati" class="form-select" required>
                            <option value="">-- Saat Seçiniz --</option>
                            <option value="09:00">09:00</option>
                            <option value="09:30">09:30</option>
                            <option value="10:00">10:00</option>
                            <option value="10:30">10:30</option>
                            <option value="11:00">11:00</option>
                            <option value="11:30">11:30</option>
                            <option value="13:30">13:30</option>
                            <option value="14:00">14:00</option>
                            <option value="14:30">14:30</option>
                            <option value="15:00">15:00</option>
                            <option value="15:30">15:30</option>
                            <option value="16:00">16:00</option>
                            <option value="16:30">16:30</option>
                        </select>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg">Randevuyu Onayla</button>
                        <a asp-action="Index" class="btn btn-secondary">İptal</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Departman listesi değiştiğinde çalışır
            $("#DepartmanListesi").change(function () {
                var departmanId = $(this).val();
                var doktorListesi = $("#DoktorListesi");

                // Listeyi temizle ve "Yükleniyor" yaz
                doktorListesi.empty();
                doktorListesi.append('<option value="">Yükleniyor...</option>');
                doktorListesi.prop("disabled", true);

                if (departmanId) {
                    // Controller'daki 'DoktorlariGetir' metoduna git ve veriyi çek
                    $.getJSON("/Randevu/DoktorlariGetir?departmanId=" + departmanId, function (data) {

                        // Listeyi tekrar temizle
                        doktorListesi.empty();
                        doktorListesi.append('<option value="">-- Doktor Seçiniz --</option>');

                        // Gelen doktorları listeye ekle
                        $.each(data, function (index, item) {
                            doktorListesi.append('<option value="' + item.doktorID + '">' + item.adSoyad + '</option>');
                        });

                        // Listeyi aktif et
                        doktorListesi.prop("disabled", false);
                    });
                } else {
                    // Departman seçimi iptal edilirse doktor listesini sıfırla
                    doktorListesi.empty();
                    doktorListesi.append('<option value="">-- Önce Poliklinik Seçiniz --</option>');
                    doktorListesi.prop("disabled", true);
                }
            });
        });
    </script>
}